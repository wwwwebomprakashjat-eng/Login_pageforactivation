<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Key.json Admin Panel (FINAL FIXED)</title>
<style>
body{font-family:Arial;margin:20px;max-width:900px}
textarea{width:100%;height:400px;font-family:monospace}
input,button{padding:10px;margin:5px}
#panel{display:none}
</style>
</head>
<body>

<h2>Key.json Admin Panel</h2>

<p><b>Step 1:</b> Enter Admin Email</p>
<input id="email" placeholder="Enter admin email">
<button onclick="verifyAdmin()">Verify</button>

<p><b>Step 2:</b> GitHub Login for Editing</p>
<button onclick="githubLogin()">Sign in to GitHub</button>

<p id="status"></p>

<div id="panel">
  <button onclick="loadFile()">Load Key.json</button>
  <button onclick="saveFile()">Save</button>
  <input id="commit" placeholder="Commit message" style="width:100%">
  <textarea id="editor"></textarea>
  <pre id="result"></pre>
</div>

<script>
// ===== ADMIN EMAIL =====
const ADMIN_EMAIL = "www.webomprakashjat@gmail.com";

// ===== GITHUB APP CREDENTIALS =====
const CLIENT_ID = "Ov23liByBWpEww6qNnPy";
const CLIENT_SECRET = "5bc3de72f78ef75aae85ec38057d2257f8b8a29b";

// ===== REPO DETAILS =====
const OWNER = "wwwwebomprakashjat-eng";
const REPO = "Login_pageforactivation";
const FILE = "Key.json";

let accessToken = null;

/* Step 1: Admin Verify */
function verifyAdmin(){
    const e = document.getElementById("email").value.trim();
    if(e === ADMIN_EMAIL){
        document.getElementById("status").innerText = "Admin verified!";
    } else {
        alert("Not Authorized!");
    }
}

/* Step 2: GitHub OAuth Login */
function githubLogin(){
    const url = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&scope=repo`;
    window.location.href = url;
}

/* Step 3: GitHub Code Exchange */
(async function(){
    if(window.location.search.includes("code=")){
        const code = new URLSearchParams(window.location.search).get("code");

        document.getElementById("status").innerText = "Exchanging token…";

      const res = await fetch("https://corsproxy.io/?https://github.com/login/oauth/access_token", {
    method:"POST",
    headers:{
        "Content-Type":"application/json",
        "Accept":"application/json"
    },
    body:JSON.stringify({
        client_id:CLIENT_ID,
        client_secret:CLIENT_SECRET,
        code:code
    })
});
        const data = await res.json();

        if(data.access_token){
            accessToken = data.access_token;
            document.getElementById("status").innerText = "GitHub Login Successful!";
            document.getElementById("panel").style.display = "block";

            // URL clean
            history.replaceState({}, document.title, location.pathname);
        } else {
            document.getElementById("status").innerText = "Token exchange failed!";
        }
    }
})();

/* LOAD FILE */
async function loadFile(){
    if(!accessToken){
        return alert("Please sign in to GitHub first.");
    }

    document.getElementById("status").innerText = "Loading file…";

    const res = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}`,
        {
            headers:{
                Authorization:"token " + accessToken
            }
        }
    );

    const data = await res.json();

    if(!data.content){
        document.getElementById("result").innerText = JSON.stringify(data,null,2);
        return;
    }

    const json = atob(data.content.replace(/\n/g,''));
    window.fileSha = data.sha;

    document.getElementById("editor").value = JSON.stringify(JSON.parse(json), null, 2);
    document.getElementById("status").innerText = "File Loaded!";
}

/* SAVE FILE */
async function saveFile(){
    if(!accessToken){
        return alert("Please sign in to GitHub first.");
    }

    let content = document.getElementById("editor").value;
    const msg = document.getElementById("commit").value || "Update Key.json";

    try{
        JSON.parse(content);
    }catch(e){
        alert("Invalid JSON");
        return;
    }

    const encoded = btoa(content);

    const res = await fetch(
        `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE}`,
        {
            method:"PUT",
            headers:{
                Authorization:"token " + accessToken,
                "Content-Type":"application/json"
            },
            body:JSON.stringify({
                message:msg,
                content:encoded,
                sha:window.fileSha
            })
        }
    );

    const data = await res.json();
    document.getElementById("result").innerText = JSON.stringify(data,null,2);
    document.getElementById("status").innerText = "Saved!";
}
</script>
</body>
</html>